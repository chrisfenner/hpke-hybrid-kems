package mlkem

import (
	"bytes"
	"encoding/hex"
	"testing"
)

func mustDecodeHex(t *testing.T, h string) []byte {
	bytes, err := hex.DecodeString(h)
	if err != nil {
		t.Fatalf("DecodeString() = %v", err)
	}
	return bytes
}

// This test checks that the key generation agrees with the official NIST CMVP test vectors.
// https://github.com/usnistgov/ACVP-Server/blob/master/gen-val/json-files/ML-KEM-keyGen-FIPS203/internalProjection.json
func TestKeyGenKnownAnswer(t *testing.T) {
	for _, tc := range []struct {
		name string
		d    []byte
		z    []byte
		ek   []byte
		dk   []byte
	}{
		{
			name: "ACVP test vector 26",
			d:    mustDecodeHex(t, "97c4789340df47850a84889820b9b4307df3e43a7de3f5857340c791934f1e99"),
			z:    mustDecodeHex(t, "d7f7fe2aa083a10a9c267d3163d0fb888c9d2d7614482095ef1817e1e9e4ac88"),
			ek:   mustDecodeHex(t, "c4308cb02b4c7a380d1b43cc2b343b01c6655de002a38cbcb0229db481bc50c9b6d1dc3a86742aefaa867ab16122f83726a71446e7b2abb2ca04fa2ff07a4910b16a73a28b66487483861a1a0a4dc86330f5051e3831631a334eb58b42295c7e4292cb43e8a53a435039a44d74c15598707f46947d45002b80197ad2e28c4fbc1f5cb53e71d808d9d38f52ea7c07a5625959a64b5a81574907337bb43bc283463c557031af36f08ec20b69ab286258564809eb072aeb0dc69028ffe1407706314bf8538b02778f5921ed40c87102467f5a4580d13b02e508b4140764a3c3265461a7b90a959c028048c723b673f1286b50e70c8af8730a674eb8f95029d181c8f478b843aa89fa55180b9ac6d3ae6fd75ab356028fb923ed329d38065662d836964811aeca796b1a862905681a39274eba7afefbba2561a8241847ca38b309003a13433102868882520f17a0049000817b9148df851d67e09078b6a1c1ea91ce5b7f1d2b2b1c07884dcb07db46691f9869e8b58323d4695b9073cde5717ff8c2dc38ceefbc24fe2630e4790583ec671ad59f6c049af994659bd075752a4ee7a63d7cda02e65c6507fa2cec73b0b6a346a67c9ff5d345169a5ff5390fe2b5c264e9619c24916a271d7838227004c57bf84ed22a3c442895dad975a96cc5fc949647484eb0872bf55a625353c09a658e1e806b26a51720c4af3d5ccf739c51a6d744bb103ba67b48aa716ceea77784c7093646716bf26b1bfb54d2fa114594b7174c567a0c48add1236ee8888c551533c7862a3b24d15568e2061c0b41232319476753ae9ecc883d7bb44bd3776adc95c587c8d5a24d76b787c92ca8a2fb64241442ec751995494a91114d0003212b9c747c1b6d18278318ca979029b637d7a0c2f2345b3bc0bd1b29dd457fe9b8629880b519cc47431066c6ac1687c60b8f961e1547c6dae75b43104b35801dc0b032fad18d6b901255e32f09981458f43bc2c63b8c262ffb947304e13b1a05bc883a5106a32e99cb6e651447d1934724f54c0eb37cc019c37228a4537b96259a825a741de4882737184022e529e803457013123bd925921943706c8ba2c2cf09d68e34753cb6358df1aca9a6cc322755333e50050fa207c1ebb1e1142b009c73004ac7bbf20a362a8df73677767388b3db57bd278999d99d69dba055e44051dac2dd5138255833be91c4c1054fb3b0994f58a7f6dc3af92cb9627943237419a8045828e7a62cbc4b15511ae0e2a31e1baf171a84b7f4ba19f22609b528d3271587a673a7931e0e0678cb017e026426b6770c8ae903c49b79f9219a83b02595d3a7a40b1d7daa33fcb8760a72bd02b96b2a20513c4a5f9ac772c64a03fe86c80e601d2a1bbdd707b10f71259fc025faa6b129e81fe5604386269f64e5cc8840a4c3a721dcc819fde555b8654992ec055131bc69b2cdd19a9343b63e8d098473fc39074c97d899728904a4f539c235e4bbed4024771056e1772fd14503149048d638537f2aa5dd339c4da15f8e3a05fe0533ccb0167cb74af29b88ec0c961b164b81626ecaf6abd876b8b8253befec3163b039088365112422efb4b3a7e17695ab36cecc06f19aa31104817bc3181be78dd30c4ad5f7684d142354aa5ec322cef3ab3a8e906088d2939a35349164df25688c015d"),
			dk:   mustDecodeHex(t, "f9c23e5887010816840bc7be9715b0c3232b94eb64b5c983a67248eae2623893cde2f6b4eb421f97d43f71f51804533705d0893b029abbf5218551b4e1d98cbf3a5a27902f92a66cb4a982cde622c4f2700bf623fd32a1251b1b067a87bbaa2ebbf03597689d6fa40063ba20fed9c841188d8754641f501b0ea78ec6b5c22b669e45f1c842f070734b409940512003c765f0626bc3764d0bb7df0b06be48441c609e53e6b0f8a679560a22307027844949a80b1768e884b69ccd51c3c8ea5c995fa24444103812a918f8a5a861ab974011ab7183060d5b522873a474c28f1e39c9ed434fe6237a0455beb09c9addf16ff537b38ea8923bcaa64c8334d16a3c7050437b350c014561dc3b34057196915b615ceb936e7c8a1ab19f0ea342fc682f48e87c08630d1bcb668f68b35657647546b245721f8fc1ac748a70997bc4ac7b3141a518024299074a4d9198301b2a866e19be9fa5251493481566bbbc313010c9980fc89baa464b8cca92871359ed925a1f6584da3b7b0be208a912bf6133b43205c722c585eccc98af8224d2286f25f1952ee63c90e41065202ab3c9752cb242ff6a26f071572df49763c357606127a4048e06e1bbce1504aeba1692e62312993b51785820a33e0d62411d187e3738761b601cf5c0c710a6c6fc028036189c011b0eda97bbd21c9f92744d0d89674003c3bb563f93d7b027c79c0b6718cfb14b80a8934111c644a9a63c30b7ca11a2279b478c8b84470cb11f74a3ddd54d8d395fbe2a54298671bcb08dca21502b694591b56ae87453b7450dab8648abf7ac94a646a9dbaeb82623b92133c94c7a36235b9a874112bb02f1f1b80f02be5ae6a0370165e854a1acc74fcae75cb117255ce08bcf24cb64467e4704a6715a4c5adbc3ba876cb5b6a34bc3cfe43718f43a04a90c9bab88cd46ec75708950cc1c1d31fa8df9ba034dc14fa64a2deba28e039622db241159f05a4815ad8fb774cb807b0667b1bbc9b8cbd8ceb8518c5fd87e16659d26963cb5074ac77046c5053cb4182dae65037e0c601ad37e25e22df4a4814ec49cdb21148975b9aadbc290fc0546d2a2f3fb461fb130a457be4276166622748fdb30e43ab426418e135660bf4a2588653ac2365e63445670ca9ce5e7afe3378555c29f43da3c0326012ffc372f356812bc79f77877e415662d788edae10e34708fd42808d8bac0d5b5148a27a41039496cb47c81c5b17a727bae2057aa33080dd0a71d6718354570cc363ad33381e16b8ac645747ed92b3a16105148069339240ea8118c2250f62691e4d62a3dbc3335019f1bd22ab8f608a8f2ac26dcb483732afb4190beb41ab30a3a987251ffc449c90bcb0ec32d2aec764fe63c19a39a5ef8a4ada206304267c0a80663a184374a811f903dd08c29aa74c9901a6d0c35506e26b8a8859535dc230dc87236c6a8baa6cf68a24abc6565e2a3ce31295916aa55b2c5a15f34a191407430771b8e9318a1688fec495f6742658646748e8a356cec16d1a48c1a23747f758ea74bbc382a3a98864ab71055cfb60448a941a374aac44756047ab40644cdd3987580476253b98033648554e336dcb954d831781b892058db9e66fa796464412954c0c4308cb02b4c7a380d1b43cc2b343b01c6655de002a38cbcb0229db481bc50c9b6d1dc3a86742aefaa867ab16122f83726a71446e7b2abb2ca04fa2ff07a4910b16a73a28b66487483861a1a0a4dc86330f5051e3831631a334eb58b42295c7e4292cb43e8a53a435039a44d74c15598707f46947d45002b80197ad2e28c4fbc1f5cb53e71d808d9d38f52ea7c07a5625959a64b5a81574907337bb43bc283463c557031af36f08ec20b69ab286258564809eb072aeb0dc69028ffe1407706314bf8538b02778f5921ed40c87102467f5a4580d13b02e508b4140764a3c3265461a7b90a959c028048c723b673f1286b50e70c8af8730a674eb8f95029d181c8f478b843aa89fa55180b9ac6d3ae6fd75ab356028fb923ed329d38065662d836964811aeca796b1a862905681a39274eba7afefbba2561a8241847ca38b309003a13433102868882520f17a0049000817b9148df851d67e09078b6a1c1ea91ce5b7f1d2b2b1c07884dcb07db46691f9869e8b58323d4695b9073cde5717ff8c2dc38ceefbc24fe2630e4790583ec671ad59f6c049af994659bd075752a4ee7a63d7cda02e65c6507fa2cec73b0b6a346a67c9ff5d345169a5ff5390fe2b5c264e9619c24916a271d7838227004c57bf84ed22a3c442895dad975a96cc5fc949647484eb0872bf55a625353c09a658e1e806b26a51720c4af3d5ccf739c51a6d744bb103ba67b48aa716ceea77784c7093646716bf26b1bfb54d2fa114594b7174c567a0c48add1236ee8888c551533c7862a3b24d15568e2061c0b41232319476753ae9ecc883d7bb44bd3776adc95c587c8d5a24d76b787c92ca8a2fb64241442ec751995494a91114d0003212b9c747c1b6d18278318ca979029b637d7a0c2f2345b3bc0bd1b29dd457fe9b8629880b519cc47431066c6ac1687c60b8f961e1547c6dae75b43104b35801dc0b032fad18d6b901255e32f09981458f43bc2c63b8c262ffb947304e13b1a05bc883a5106a32e99cb6e651447d1934724f54c0eb37cc019c37228a4537b96259a825a741de4882737184022e529e803457013123bd925921943706c8ba2c2cf09d68e34753cb6358df1aca9a6cc322755333e50050fa207c1ebb1e1142b009c73004ac7bbf20a362a8df73677767388b3db57bd278999d99d69dba055e44051dac2dd5138255833be91c4c1054fb3b0994f58a7f6dc3af92cb9627943237419a8045828e7a62cbc4b15511ae0e2a31e1baf171a84b7f4ba19f22609b528d3271587a673a7931e0e0678cb017e026426b6770c8ae903c49b79f9219a83b02595d3a7a40b1d7daa33fcb8760a72bd02b96b2a20513c4a5f9ac772c64a03fe86c80e601d2a1bbdd707b10f71259fc025faa6b129e81fe5604386269f64e5cc8840a4c3a721dcc819fde555b8654992ec055131bc69b2cdd19a9343b63e8d098473fc39074c97d899728904a4f539c235e4bbed4024771056e1772fd14503149048d638537f2aa5dd339c4da15f8e3a05fe0533ccb0167cb74af29b88ec0c961b164b81626ecaf6abd876b8b8253befec3163b039088365112422efb4b3a7e17695ab36cecc06f19aa31104817bc3181be78dd30c4ad5f7684d142354aa5ec322cef3ab3a8e906088d2939a35349164df25688c015d345f067d4a9b077fbf18f7561cc71d409d21a3038f1eadd46f165e47b736ed73d7f7fe2aa083a10a9c267d3163d0fb888c9d2d7614482095ef1817e1e9e4ac88"),
		},
		{
			name: "ACVP test vector 27",
			d:    mustDecodeHex(t, "a930919e0bd10943e56b216c31d7a9f7949e9a1225fe03c58ac42c401176e9ec"),
			z:    mustDecodeHex(t, "c70dea33b6bc2813484e8d9b60cbb7d2d02e26fc01a74b9363485b34e5529173"),
			ek:   mustDecodeHex(t, "f547862648868fec6e3222cf7034524b60c05b116f3bc45038f5033b5705b829791b1c2a2786a8deb9024e04605a10932690026cac16a043afce573de6189002741a1966951ee84ff823af6aa04e9f45bad98c9a907c0aacbb440b096802745a2eda13eb444be641b2faeb5f2d72c71191805cab4726b3cf3cc89bffe8b030da805bcc62e957a254bb3e1db2770b946711514ac96ca7484605562a05562b08d5031705c9539057c441a546a71882ee225f50365d072928a5865fce655ce4aa206799cb0d497563f008be7623a9c52256a94a662b9e9c85c0b56bb7049884069a68290459836b5506e73eb8070eaa9230a307b14248b6cd302a469b2c31e815f144a43809bf65f1abdfc20585102257987ffd0a651fd9c79cb299605cbab700161e999474b44e06853ac1b0aeeaf3867c1a7757e3373fb39123ca1e6f83ba1dfbc55cf57474dcbcb239983c18a9b8283999d878be159870255f9ca4c684fc7f33b84e47d79fe409b529794a7a943e6bccbfcbf2a24fa95ca88587723ab560fb028037247e1bc69a76c7b972692945a70adb03af7498961bb1c8d98d90714024798da81a5640418096836a0294575631619b336faafa43acf914a106cd42268f84919015786d0a8abda5ab8a16467e30b86aa5119f77f169e148c825dc8f47784f15c6c93486031332c8372a75f8aac381fb462ae505676941cd3698d0d68c50750865ec12db113b188332e37c37439a024ef34f5bf8a1a0d55454c315d48a1c6ad81c3c08a9969b6c3cc76ec2600b62ba342ca488c88b3de0cac7110cb6d66062f638100cb44cf94a7a745645e64a3c2d2102472379e3ec01b30181ad60787266ba21b71d7b070bdce0643b0a79ff661c02c053664192d7d585ee871528641a5e7b723b14440505a69e3b17a6c5511af785216120997400affb8d3871a7b6446b160caa18698f919610f7028ff3764d5a482182611586562a6e767391282c7fbb4885f41d18477015db7de8ba9e36382e34d7549ad72a0a03071e3512f221ce4963b1b4c6449301bbfce81f9e684890c3b4bd1023bb858284352c94b83a9729b42c590eeedc902df3aca69712ea6ba744ecb57f26753fe61e2906a4c7d4436f49588ad81653a7ad6ab6463078090c15ac40f39a37ac2dce42a6ba94bde6899263d15d5810baf0455defb0660c5a0c732c65e72790046329cf387a6d41298a984ce7243937a73a2907249747cb3a60b8980118932cc15becae3d035868aa5eedd9bdc766b1a1e67f03b3cd4c37b10bc530fe16c552d42c023c53087413e2290005e5ced1019ff8426f72a596d95ac119e00c88933e100358b99070bc088390738d4b8917cbdc0d3654635ec079c02603d41a62e74c01cfd2a5b7d9807516594db30904b3a3066494fcb19f70d032c0d5076fc8115777100653c08866086a1b3adcc072573b5984530727140efbc99aee1cb31f874f530c36a0a6480e511752d1c55ed5b726a9395bc533dd9074a72580bfd25d6f929f8ea89cf9e19f1cac284ad6c6e444b9e901730a3c809d014c4f8bc335215b7aaa7efb379dc6c25427d827c151434429670af237b7d810b9abcec6a2b7e6a61d367aac0c33531e215c46f12b8cbd888a1a45da009357e2e35fdfd794889eeda28ffc494fdc73303f1db4a32b"),
			dk:   mustDecodeHex(t, "2732ad90877c44b9384e72ca274474c22750c2094801a3306da5b262953b5ee1b31ea9cdc4156e3c4acf8d25a826fc6faec27ee6e512307225833bacaca67b9aa79d49578711565553352b527a9b26e471c5098b304182816a97a5342a7f61b71b59adbecc56a982c341351f7552046e397db48a24708a7c5143b7ba1575727a6c68e45553eabdb33238c7a248432b4fb5ab5359e908f2b109f2825109a7838be600309637db7aca5996388039165f7b11de12bf43843ebf7ba653b83086b960e5422bf7001d73a3462a75c9de1c49ad763158977f8e721ee6574129a8661bcc272752a4ac980cf76b8368d38ab1a17c57100aada854402bae1f4463c5e41879a64c0155b2910a1afb237374217690b785e6dbb151e49b7183999ee9221856a1ed23b918a3ca8d481c8931b26e8c7c566c444cc4b9a219ab5c1804f8ab6a96205f40cbcf177b1c3bd475bbc33f32ab3ce1bc96dd2800d5a4172f4a1eff9820acba60866077e9b45d57610e14f91e4c034fdf354648c18388592ca850ae9a74232f78893bba2b9d5876f4d01af30c446bd5b1a0a0a339a59c3e09b3d0e432e7c18edb7c6b81c7573bd69859e25ffe57a10012bbc12699742946bb572821a00eda87b89e59b5d1259019c0bee3ab809058371354658bf5b6eb40bc8029b6337580eb3a42b3aaacc6f79e5a93adf65b6720dc55b69b287f6b0cb601c34c1482f880aa9deb75f8c81c6e4ca8b4b1217816ad44a90e37078396098a562a2c90d61c594b548dd49cbc66c82d10c30f82ce4d1b42274c2be0350d54882c51d90f6c2b7cbc3887e8346be654389e8a13d04797a6e998383cce5413161709bfe6e193e7819110372664f99937e2472fc1b4c727b8595a10800acd82a2aded116f42c8cbbf18a9690bc4e2fb5c6831041687696c4388a73cc7197b0543108b6c8c9c9da9ce5e7b7cc98763b18a6867948721fa42de612ee9c02f8ef617b3809622a19deb19a4c8a59e5c9702b8966f728c8b1483a2b6b2568dab0521a72cf1524df587905d49076716937c165f02ac53e4924d12c8335267a077d9ad6d1022a9181c319b2217825f51ab632c77736bb5c63cec2a2aba0a1f94c8f3f274bdeab6661157c2c10b92d8cab859868e22b192dc615a720b8fba9747903a631b9303e162a8713f292029a7f05b2c1660fbb57c4f326ad99077f5cc09bfd4a10871cb30cb94b795854b62c3bab83f7e72991a2abda41821f661ce2d036addf1092ba05a6eec6ab5ab585a2922a48173d6060f2f211940b14882a3b86c131a526acd55b099b2e35936966487ab5f673c765b3b72ad18c0fb29153dcb371b15c121d32da55050392ac8c87c69c3a6b86b163329545513c3a6957279a934089a31923301055a699c533129b2f447435b2cac2199ad93549b8a86078057aa532fb26b150e3a3ee231cd7cc4c75a260ede6b7f58e3ad5fa985649b7acb1ab88509c8d3eb22f3567d56869a5113c76321b7862400c3da84b940770e09a1da1792164135a6c4ca82ac166e62b274e3bd6d50abb4a87781428b6ffcaf91d66fde068e168b8c8b7139d8e4a2ae2184e5f370dd41be57584510b773d7222744c0729e122cb4c962b386aa4e2a62f547862648868fec6e3222cf7034524b60c05b116f3bc45038f5033b5705b829791b1c2a2786a8deb9024e04605a10932690026cac16a043afce573de6189002741a1966951ee84ff823af6aa04e9f45bad98c9a907c0aacbb440b096802745a2eda13eb444be641b2faeb5f2d72c71191805cab4726b3cf3cc89bffe8b030da805bcc62e957a254bb3e1db2770b946711514ac96ca7484605562a05562b08d5031705c9539057c441a546a71882ee225f50365d072928a5865fce655ce4aa206799cb0d497563f008be7623a9c52256a94a662b9e9c85c0b56bb7049884069a68290459836b5506e73eb8070eaa9230a307b14248b6cd302a469b2c31e815f144a43809bf65f1abdfc20585102257987ffd0a651fd9c79cb299605cbab700161e999474b44e06853ac1b0aeeaf3867c1a7757e3373fb39123ca1e6f83ba1dfbc55cf57474dcbcb239983c18a9b8283999d878be159870255f9ca4c684fc7f33b84e47d79fe409b529794a7a943e6bccbfcbf2a24fa95ca88587723ab560fb028037247e1bc69a76c7b972692945a70adb03af7498961bb1c8d98d90714024798da81a5640418096836a0294575631619b336faafa43acf914a106cd42268f84919015786d0a8abda5ab8a16467e30b86aa5119f77f169e148c825dc8f47784f15c6c93486031332c8372a75f8aac381fb462ae505676941cd3698d0d68c50750865ec12db113b188332e37c37439a024ef34f5bf8a1a0d55454c315d48a1c6ad81c3c08a9969b6c3cc76ec2600b62ba342ca488c88b3de0cac7110cb6d66062f638100cb44cf94a7a745645e64a3c2d2102472379e3ec01b30181ad60787266ba21b71d7b070bdce0643b0a79ff661c02c053664192d7d585ee871528641a5e7b723b14440505a69e3b17a6c5511af785216120997400affb8d3871a7b6446b160caa18698f919610f7028ff3764d5a482182611586562a6e767391282c7fbb4885f41d18477015db7de8ba9e36382e34d7549ad72a0a03071e3512f221ce4963b1b4c6449301bbfce81f9e684890c3b4bd1023bb858284352c94b83a9729b42c590eeedc902df3aca69712ea6ba744ecb57f26753fe61e2906a4c7d4436f49588ad81653a7ad6ab6463078090c15ac40f39a37ac2dce42a6ba94bde6899263d15d5810baf0455defb0660c5a0c732c65e72790046329cf387a6d41298a984ce7243937a73a2907249747cb3a60b8980118932cc15becae3d035868aa5eedd9bdc766b1a1e67f03b3cd4c37b10bc530fe16c552d42c023c53087413e2290005e5ced1019ff8426f72a596d95ac119e00c88933e100358b99070bc088390738d4b8917cbdc0d3654635ec079c02603d41a62e74c01cfd2a5b7d9807516594db30904b3a3066494fcb19f70d032c0d5076fc8115777100653c08866086a1b3adcc072573b5984530727140efbc99aee1cb31f874f530c36a0a6480e511752d1c55ed5b726a9395bc533dd9074a72580bfd25d6f929f8ea89cf9e19f1cac284ad6c6e444b9e901730a3c809d014c4f8bc335215b7aaa7efb379dc6c25427d827c151434429670af237b7d810b9abcec6a2b7e6a61d367aac0c33531e215c46f12b8cbd888a1a45da009357e2e35fdfd794889eeda28ffc494fdc73303f1db4a32b2b7ed888de8b914bd7b2f28065c1f2dbf4421d4aa7fb3ce591edb948f2d4b179c70dea33b6bc2813484e8d9b60cbb7d2d02e26fc01a74b9363485b34e5529173"),
		},
		{
			name: "ACVP test vector 28",
			d:    mustDecodeHex(t, "7e09b756b87b9805e0034bf69de4ea0555c3b435ee338266cfdb1b0d1fd503e4"),
			z:    mustDecodeHex(t, "c08ac5f53bad87be2d6175370063b23bab442f9ee170e443fff3033f3ac56655"),
			ek:   mustDecodeHex(t, "4760537d8cba8d01783a48c465eca42c9390c992181dabce5bac3698f865c592034ac90c56fc000f084d67105e90d4a3d207c518e61fc4663471a99f6c1999f3f717556264e227b42d1539dd9285af880dc42039b81282a372a761f680782b113198868ca71e7c022dd450980409321144139b7b5c2a219e79c95495545966f891e611370a0944d0209fce566b62b82d11c8bc84016d46e1251b195b60e9afbe62ad2c687cc247371fd6b82f27324dd2590e5baa324c3d9670b6644b8fb78c15b689311eb91a089a1c3fb492295a8f09c8af47356bfe67b0409c4e14592d541a961044a611e9b99914995cd53ef5ab87cd357b0bcc82a7402a29518ee23254fa812bea3893830410a897ba63a0008ee86585587824f329707137c1c0869831912c065c7f46c0b6ca8bfba451fc6799576634011871f0e3ad713c237460a78d1c678182a0978156fe7a5094807e61031985c7a289f63d6bccc40678aa69d8331eb75585c83646b5ae78c66a43f9770ab0a4148167104939a5e691a7fbbcf8939ff7e114256a4236109b13067f77795612b7b8d08c01166921c10ca8f9951c8b87b886159db8c3c197a27a833561af9c37d9741eabc5838bda12db2c3a97678267bc81fc718917d01622451a27c797495ab1035ccf4ee501da5ac6c5e202a19320e7912f2ac3a956c33c51931c13970f7702723186101056a11d022bf7526c87c66b99a2c921259e13718a10bb2f0cf7acdd3689377a75d41284423b3194465a69542cdea1c63acc684d1a351d603bbfa28a652595a875b6d0810974bc36920b7a085802aa3b2c2675516b7a0577350f15b9a5eb5465d308d07d216c1e39c05428910dc549357553558b7d77001c372b242d12084ae063d2ab72c397671526360ac0567964cd10a65542861583e61348da1b0a6085c2ec2d97508911d24bfea921eee996861c6e9b32016691cbd7fba8ef1bc663f62cea47a2ba989d4e0a47572573b31b411fa862bb2404e8d0c963321626746bad41397f586dd2ba8698bb6c6cdb79edc73e22881dc17218fafa9aa7da38288154716a8ec9904aee684ac77c40b922550909b9c7a360f2d50d4840775d1162f9f57737d5314511cb921703d29b7e55a57f1abc7716700c89aa92307b9ed56b12f84c7376e78ef67cca81686753cb9b61fa402b96909d20080601a9720c9999b8813ce53203f8a86c9a8df7a27d56425fe73ca6efe57c8a5824479665f3388bf133c139688711b36186c7c5303c7038f4309bda00b4068c27c8a794279928570bda519702183c69e175823211026664b650c6fbe58ccd295a57e18fc34234a6b15bdc22b6c17642313961dacb50de79c18f650b27aa9a12b25487739ce715650556a4c1c393ffd5145294a1637a88987b18c0a80979c1ad85a250a1170dd7cccb8e558dc17c04afcb658cf0864a8b1c4a2044502948d724732ea17f5d6b96cea122bb54855a9b80636803f3248f462308361009db9c558d440d67f8cdc63b5e809128b668b04f353abcccb6131cbc714275dd8161cd226ae0b1083d2bbf7bcb0b2af35be3443a472a5f4dc4a8cc009d5f7ca9267b378de82194829095d4bc2aa573a458b60ab9841d256c7405211ac326f050e030e7e8edbe980e4e94c0aad40ecf6d83d1c060de9df0bb4b7ee9"),
			dk:   mustDecodeHex(t, "13c958bcf82ed76c18812747b7f583d9aa760e7104b122aa154b9c4532375ef5104a27a08f5bcfbaf05d9999196714840a364ab1f13812499881e97d5e65cbecdca9c9d0cdcc4643b09b2bd3b8a36bbb493c51113a02423709071e151bf47a519423c6c0217027815bd922b8826b6e7af99e6ef633b77969de884a594c7834137ef9618cfa9a1d38dcb115f8863bf2a9e6e92f0db5021cd20793948ed1d74cf07a970f69293d8bb65651102d84ab69e924ae816128f7c9490574a328cdb0ca82c848621357a8e2f52c800b9c1a35aa815a90576c7f8cac6fe0c7035fd41fe4abc90ee6963bbb4d4f94a591c75224d42c77301a00aba49479417f80aebeb2c1d9570c5c2052fe47ce7011b5bc12cac06161cb572e34b60f6a84510e81417d08630565525e278a777ba28c4b7a42a0245aaa34f0918440f348475c7bd0204c4ee72b4b68568afac25f2954050530ee87b3d119c243cc851f6549b4c91de3d84670f7a903b9a3f943b2a7fb7084a73438b716ffc5b73886c0696249f19c2fd3562193c2c8979469e9295be0488db575906fb02ed8289b38d01a927bb7a2b13d346a436ee27e564a51c4995867cc6692fa36efc9cbdc8103a971c42804b28981ad6e1a07f2da5289da16f0c1ab5eda7145351425f3b3af254d25064170d7806e598eb4ec618d3a3e3867b26e1b854e19797e0ca3eb63afa24ac2566695b5d76dbf1115cef8cf83a10addf60e10e759d4b34c44d3771df12c8a2911b011cf8e2214b75a08bf863679eaae90e8ae4b7b530121c0e5ec042966964c933723d26d2d52c15d4623a01c53f5f426e7d34bc72b47721c0aab9301f4306848f5349fd22d71c19d1c6b8ec44ca572868b9d1b4ec22c9ed16670075946a613246a28bbe96a499a32a3af284f1a833e3daba27ca2c42d4bb650198551744a6b0c68a2046fc0370edb45c589191b95e96ad92677b0c33faf371607022c2354bdd2daa8005d11f3b405414cc013a2a1bcb4b372a8694c7201f9c6920b5bbc1156820980262020971679ca7f70512c627a9de618a7e233d219111c8989b8007853455f019ca5138530dbe36efc8a334d6ccc07178516c0cd831275c3029313d66e2d894c8c7697ae7c08524c2196c58e519c3d32d667c0abaaf260794a70268ff24f10f80d6e25a76f447fe1062cd4fc3beb4416933c811bb502f9746c5f8876567b177fd8548ac774639bab6927671721bac3b22aab590722061d421782b9a79af13556af4b948348b147f2309950634cdcc7be16c62306428909be967a54a8784892380ee3fca79b4373efb185e806b5c80a49a3a33044902c824c161167678b77ce53c8164bb17e476b535ce401087719b1a15c924881c0fb1b2b90ac154b7faf8bc17c6b1274c5980e250b3d283e6b703362d67ff81694adc531fd58838fe66d67ec5a1b6419c3f4aa8d8b3cd2bc3d7cc34dcb972556217e39a63855a58c6080ade700742576ab836c87545b9c55501219c586fd0b509d30608cb5816427244a589ea96a12709b5221ca768427b25f8a2e4b3c7bed060f1267572f3963dfa64c245b1d1afb2354f194a803914f101601eb68bd5b9472065deb27cc11c71f34722047a6a656739b4760537d8cba8d01783a48c465eca42c9390c992181dabce5bac3698f865c592034ac90c56fc000f084d67105e90d4a3d207c518e61fc4663471a99f6c1999f3f717556264e227b42d1539dd9285af880dc42039b81282a372a761f680782b113198868ca71e7c022dd450980409321144139b7b5c2a219e79c95495545966f891e611370a0944d0209fce566b62b82d11c8bc84016d46e1251b195b60e9afbe62ad2c687cc247371fd6b82f27324dd2590e5baa324c3d9670b6644b8fb78c15b689311eb91a089a1c3fb492295a8f09c8af47356bfe67b0409c4e14592d541a961044a611e9b99914995cd53ef5ab87cd357b0bcc82a7402a29518ee23254fa812bea3893830410a897ba63a0008ee86585587824f329707137c1c0869831912c065c7f46c0b6ca8bfba451fc6799576634011871f0e3ad713c237460a78d1c678182a0978156fe7a5094807e61031985c7a289f63d6bccc40678aa69d8331eb75585c83646b5ae78c66a43f9770ab0a4148167104939a5e691a7fbbcf8939ff7e114256a4236109b13067f77795612b7b8d08c01166921c10ca8f9951c8b87b886159db8c3c197a27a833561af9c37d9741eabc5838bda12db2c3a97678267bc81fc718917d01622451a27c797495ab1035ccf4ee501da5ac6c5e202a19320e7912f2ac3a956c33c51931c13970f7702723186101056a11d022bf7526c87c66b99a2c921259e13718a10bb2f0cf7acdd3689377a75d41284423b3194465a69542cdea1c63acc684d1a351d603bbfa28a652595a875b6d0810974bc36920b7a085802aa3b2c2675516b7a0577350f15b9a5eb5465d308d07d216c1e39c05428910dc549357553558b7d77001c372b242d12084ae063d2ab72c397671526360ac0567964cd10a65542861583e61348da1b0a6085c2ec2d97508911d24bfea921eee996861c6e9b32016691cbd7fba8ef1bc663f62cea47a2ba989d4e0a47572573b31b411fa862bb2404e8d0c963321626746bad41397f586dd2ba8698bb6c6cdb79edc73e22881dc17218fafa9aa7da38288154716a8ec9904aee684ac77c40b922550909b9c7a360f2d50d4840775d1162f9f57737d5314511cb921703d29b7e55a57f1abc7716700c89aa92307b9ed56b12f84c7376e78ef67cca81686753cb9b61fa402b96909d20080601a9720c9999b8813ce53203f8a86c9a8df7a27d56425fe73ca6efe57c8a5824479665f3388bf133c139688711b36186c7c5303c7038f4309bda00b4068c27c8a794279928570bda519702183c69e175823211026664b650c6fbe58ccd295a57e18fc34234a6b15bdc22b6c17642313961dacb50de79c18f650b27aa9a12b25487739ce715650556a4c1c393ffd5145294a1637a88987b18c0a80979c1ad85a250a1170dd7cccb8e558dc17c04afcb658cf0864a8b1c4a2044502948d724732ea17f5d6b96cea122bb54855a9b80636803f3248f462308361009db9c558d440d67f8cdc63b5e809128b668b04f353abcccb6131cbc714275dd8161cd226ae0b1083d2bbf7bcb0b2af35be3443a472a5f4dc4a8cc009d5f7ca9267b378de82194829095d4bc2aa573a458b60ab9841d256c7405211ac326f050e030e7e8edbe980e4e94c0aad40ecf6d83d1c060de9df0bb4b7ee934e119755019ac71d90c112d9e4b30481e29a4e3497102170612a258ae642bc1c08ac5f53bad87be2d6175370063b23bab442f9ee170e443fff3033f3ac56655"),
		},
	} {
		t.Run(tc.name, func(t *testing.T) {
			var dz []byte
			dz = append(dz, tc.d...)
			dz = append(dz, tc.z...)
			pub, _, err := MLKEM768.DeriveKeyPair(dz)
			if err != nil {
				t.Fatalf("DeriveKeyPair = %v", err)
			}
			pubBytes := []byte(*pub)
			if !bytes.Equal(pubBytes, tc.ek) {
				t.Errorf("ek =\n%x\nwant\n%x", pubBytes, tc.ek)
			}
		})
	}
}

// This test checks that the derandomized decapsulation is correct, too.
// Unfortunately, the CMVP vectors don't have the raw d, z values used to
// generate the keys, so we use this other test vector set:
// https://github.com/post-quantum-cryptography/KAT/tree/main/MLKEM
func TestEncapDecapKnownAnswer(t *testing.T) {
	for _, tc := range []struct {
		name string
		d    []byte
		z    []byte
		ek   []byte
		dk   []byte
		m    []byte
		ct   []byte
		k    []byte
	}{
		{
			name: "count = 0",
			d:    mustDecodeHex(t, "6dbbc4375136df3b07f7c70e639e223e177e7fd53b161b3f4d57791794f12624"),
			z:    mustDecodeHex(t, "f696484048ec21f96cf50a56d0759c448f3779752f0383d37449690694cf7a68"),
			ek:   mustDecodeHex(t, "01f60af1dc8e6360ae78b59d4a5042eb9145a269046d6236b8304f305c2d9dcb189fe5a62df89b2f5a7bce3bbc753c1e78f730a99869f809aba856b676b707b26601d1d909bab32451494eb7d0a2153a6350b79789a9b115f83ea12037256562f06a1d5aba378da77039d3bdecaca8e6a22a49050a76300a0267cdb38b7ac77903c50ca53b99283cac6b95fba651b11a4d1a692e4072965060587669f253b1bb182e661446168ac60221894660020e9bb5f5b7124a0303e2543ea3ea6ce97a2482b255ca346fb27a847b33b93f3ab2d33064c6e6632d1a23f1144e907b246b479f4a5c928929a1e24150f5241258a5b67766a66f6a33846495907828ebe44ecc5b73124071ba479073910410a16d5d5696b48b194752979795772a91c348f502b37aa650983ebb89bf3c081ff273544129c9137a6e1834c8f2e7ce14c7870c53c05b9b94ecd38e6645911b0912336863ec168831f811881075cf38a59de4b5c738aa6ef03d779b295588cfb62491cc7b3e08b48473354f9ac8061c152a9e205997499b970b69bce66fe42bca2924ccdf0103d0a4c39193c2df25118d72b17aab26b0c60d4cd2c306ca4696c185de05035f4a09cf970aecc8cc93436f83b1aeaf452c41929a2eabc151938f74c93b858546df2264eeeab602e04a85c522f8fb1a5214afd8d4cae57a47b6f381a23126bd9917173128af917f1d483691c450d1151cfe9a1492d473ed862e27da92500c86a20019e9f975e4f54ad319ba2c5630c4014219d7ba235456fe530140193d662445e6a941d1e238567ba8d4d95ab1c7447d690821876d017270cfb169f2d792f03c800720697b410ab41c66f2b24585125655eb10aa1087ffcb7750cb887ad4467377500a6a7d3a82976b415a54469577b4138d919b03f4c9a4d3390bdcb6f1717a5fa4ab25a34f4ba5039bb22c7f3c234ea4427347aa7251464e631904d7cac4784f78b49d5f4a104a301809a779f6466131f9c62bb67147f4cd4973a6aa1c29ae6a8647b6268be089fe048ce990cd638743d285c889a707f581b63af41731f0246b054bc4b47aab01b6842a2709d02e8158ab90f48b69d136082b34cb0673b74aa3f54508ed029fb8f5045ee0639e150ee3b3c85f68a310ec0441980100b42abf2bad10d4a9e0c7b2bc5bbcaf73cbcdc49dc2c949111936779b178974a0392947745a47189bc3fa8a679c80af964a9f9b1b56577274a2a669d2da6704aa496af407fa1aa964cc3dc3140f5f959a7ea974bdb1b83e48a99c0a3e2d75b0669b5c1278962540609166266da18886fc237af30cefd569dbe399e6652e45f06a5dfc9a758a4987088ff8e38a3cf36b9d988f0e070b68d0b88f7bcc41306080d889780c7e238895ccaa4f3577225cca4c8a9330ce613e717798c9670924b271ac402b51538b8b5967ac490dcab5300e6c54d6a3632f3b973e4186ee1a7e2e85649185b26370c387235c4df28a9937a49d4078bf883f4e6346cb3251d9e13f1bda087b285afaa80e262641c5527b0a184b8bc84a62e577314658e2029d850064f7a7b81f253e7cc124a9c5b039dc9b179a80c2f6aee6ea0815172537331a57b505baa76ff5b4c1f0da754b6194f4b39a9b18730d3cdab925d691ed77a8db9927ea233ac2a12744fdc27e5d221b9369adb325d8"),
			dk:   mustDecodeHex(t, "9c700fe444904db5708e16b1ba7650fbe94f24a6abba262ad7acbd1a1387756566e1ac7a1e545b236c548e8661c5f468c58c3bbc49cccafb7a66a3b61678610784a88a8872255139d979bdb140649b06acbcc91c74d3bc791591b0f31f2c9ab24d329934795405b7570a994e0d128aa08681a3cc58680937401a563bfb4e621a4193416ccb1c3c9d9b23dfc9979f91140b37c6e7a517ae6c8f268b3346e52ad0a311f79acea0a56cb9291ca0161a98aac43ef2ba55618312910012ab603ac4c0be64a498e58ecb217e2a102b8a518bbbf9c457412f030c1a82cc7ea67c8fd14511e55436daa7383ee2c942da15f67581f069563e8ba3752ba159314973dbc7374244ed486c6ad77abbd89cab1c1934153439b58f586bcf00813b050744debb789dc4b3a1d054e710905f066bc2ab7643d2883e096e749988a0612667633a9b98748c23c708d29891e84edc8c4cbc43999ec88c8a854d69402b8ebaa4d6cc09ab42220b8413da34b7cfaab2c6b47f1610cbb1d8b080051fa7d974ff53b71c8726aaac2f3daa9c6a68932d0172f2174d989090b822bacf105b7ae70fa59296d6b2c7614900a9f869db16600939bb1e116b1ce913ceea4ce60a2cd98cab92e2880070866fe04b0423c0dcec04d3f921fb8c0ad5c16a077a3f2484212d90ab2bdb1429ca837af87d29d63438440a273c3e9484a1481b54e68712e3fcc1e562799243ba3f339bf1025c5c1b29e1294a0a7a3efbb75e47b31c12fa65c90a7adbcc2aeab0278c96513b25945dc32b9f382d2751a27ca572524127695765f9b45c88f923c28869bda5c7af4060042913f4d330c0453c985442dca58ee28a94bfeb85f2b49c21a556fff04e09d66aba875a4819390bba7586f77bdfc0b1f639b586fc591ab9250c8951e143c2f9c790697ac51a9c153b493315644a73274674fb083c852a1072b80181be1ecb8f59769ee0903757326625376f9fba3380a55cca42786e11a4769c7b4761c5f5db112df69839579d82ab0340a34dd62c15165bcd67b66f0465546af56b6a637467393b28242c40c387000349a60a730237250709b208956d00fd715b239af96c418ac0147d0c63f8f9af30a272cbd629293395cad10937c32e7454815f93aa9a4c0661dba4dbb1069fa4b59474cf8f10ad45563c983906ed324b5f776e5725be938696c0f6799e489d8b80656913c687374dfeac8adb31536c90c6079069ee142fd800b3721b0aea35220dd04d85b19b872548e7005e92e674a235164d6a2e53b6774af42d211c77bd6454c2445f68d04f357106afc8c0a2bc8e4fa467676a2957b060f0e9923a639274977216341b1aea876a0b7dee4013bde2459c957dcc2b5263b02e2ae3a6904cb856c49bdb5699c16997953cb1056a4cfb362ad3646fb5d7393418b8fe556f1dc924cc74b3f9d7876473355e2751f3e98ef5eab3bb974fbe884d0bda85b8fc4dce0c852853ad7a62528c3bbc32002fa469bb89895621944ffa29429c106c3946320ee9bf3c822115d53e968a76c2581e00f906e60ca372a22686d74c9ffb52a24abee52b788d015bf6a5c7575493527c97f927561df15d47f558b5466c8247277ab35c0170c6c05a8af8e67edf524a01f60af1dc8e6360ae78b59d4a5042eb9145a269046d6236b8304f305c2d9dcb189fe5a62df89b2f5a7bce3bbc753c1e78f730a99869f809aba856b676b707b26601d1d909bab32451494eb7d0a2153a6350b79789a9b115f83ea12037256562f06a1d5aba378da77039d3bdecaca8e6a22a49050a76300a0267cdb38b7ac77903c50ca53b99283cac6b95fba651b11a4d1a692e4072965060587669f253b1bb182e661446168ac60221894660020e9bb5f5b7124a0303e2543ea3ea6ce97a2482b255ca346fb27a847b33b93f3ab2d33064c6e6632d1a23f1144e907b246b479f4a5c928929a1e24150f5241258a5b67766a66f6a33846495907828ebe44ecc5b73124071ba479073910410a16d5d5696b48b194752979795772a91c348f502b37aa650983ebb89bf3c081ff273544129c9137a6e1834c8f2e7ce14c7870c53c05b9b94ecd38e6645911b0912336863ec168831f811881075cf38a59de4b5c738aa6ef03d779b295588cfb62491cc7b3e08b48473354f9ac8061c152a9e205997499b970b69bce66fe42bca2924ccdf0103d0a4c39193c2df25118d72b17aab26b0c60d4cd2c306ca4696c185de05035f4a09cf970aecc8cc93436f83b1aeaf452c41929a2eabc151938f74c93b858546df2264eeeab602e04a85c522f8fb1a5214afd8d4cae57a47b6f381a23126bd9917173128af917f1d483691c450d1151cfe9a1492d473ed862e27da92500c86a20019e9f975e4f54ad319ba2c5630c4014219d7ba235456fe530140193d662445e6a941d1e238567ba8d4d95ab1c7447d690821876d017270cfb169f2d792f03c800720697b410ab41c66f2b24585125655eb10aa1087ffcb7750cb887ad4467377500a6a7d3a82976b415a54469577b4138d919b03f4c9a4d3390bdcb6f1717a5fa4ab25a34f4ba5039bb22c7f3c234ea4427347aa7251464e631904d7cac4784f78b49d5f4a104a301809a779f6466131f9c62bb67147f4cd4973a6aa1c29ae6a8647b6268be089fe048ce990cd638743d285c889a707f581b63af41731f0246b054bc4b47aab01b6842a2709d02e8158ab90f48b69d136082b34cb0673b74aa3f54508ed029fb8f5045ee0639e150ee3b3c85f68a310ec0441980100b42abf2bad10d4a9e0c7b2bc5bbcaf73cbcdc49dc2c949111936779b178974a0392947745a47189bc3fa8a679c80af964a9f9b1b56577274a2a669d2da6704aa496af407fa1aa964cc3dc3140f5f959a7ea974bdb1b83e48a99c0a3e2d75b0669b5c1278962540609166266da18886fc237af30cefd569dbe399e6652e45f06a5dfc9a758a4987088ff8e38a3cf36b9d988f0e070b68d0b88f7bcc41306080d889780c7e238895ccaa4f3577225cca4c8a9330ce613e717798c9670924b271ac402b51538b8b5967ac490dcab5300e6c54d6a3632f3b973e4186ee1a7e2e85649185b26370c387235c4df28a9937a49d4078bf883f4e6346cb3251d9e13f1bda087b285afaa80e262641c5527b0a184b8bc84a62e577314658e2029d850064f7a7b81f253e7cc124a9c5b039dc9b179a80c2f6aee6ea0815172537331a57b505baa76ff5b4c1f0da754b6194f4b39a9b18730d3cdab925d691ed77a8db9927ea233ac2a12744fdc27e5d221b9369adb325d86ff694a73b6701f2a7408773f9909118ef52e1c89285b2cde465a0b04980120af696484048ec21f96cf50a56d0759c448f3779752f0383d37449690694cf7a68"),
			m:    mustDecodeHex(t, "20a7b7e10f70496cc38220b944def699bf14d14e55cf4c90a12c1b33fc80ffff"),
			ct:   mustDecodeHex(t, "16a61ff84787fd4a5f19ca59b3657db3a106a7329e2d62747a2ef85149163109befff6bcb33df66230b8f6725ce719f58f71196e895befc9754d9f042494648c88a6ed4c4cf13f2faf9f651de79dae077733cb235f9dce448977fd42d5486b7dfdf6d7bd9172b14247655d34f10524d469478d9a9639f34d2acde6e3c048d52b308b66245fe9a28cde7983b9d14c03b37715fe3970cd35734771add7aa9b58cfb0adf8c613deafb2b31f6e5c8364d4334e93af8e4943fa947cc67667447cffd036235afaea7f603cb2ea277b97dadf82ea746f6b27396dd08c85cff9304a2e5ce0571fde2e926716bc9f8e4d474b4e8fd34b0dc28376204ea306d30e9a6dd88250b79823e77319f2ef3a77704f409dde8beb6db1be4a9f25ae2e15939dedf1b11a5aa51fcff04068b46d42fbbafd2498264cca4fb78b0f2ab162c7ef569875a13148b9a4b0b9da1787ca0a7033e3eca13471dbcbbe15e34f2b5065b995fe221c2b7ac150334d14e68edc5e049663de362fae8d35e24c202c5fad2153cd044ea962a388f030cdc5dec1c3423183b173c32b22f5800ae45e8e89c8ee4617ce24e60f278bfd1ea0f8fa92486b6f849127da99be7be4c661e2ba26669d6acf619a33056809683e24a2f29e33be7f5f9ac668697e59488e9b8685956cd87b7c47109d603202c201472ec829ea64922e4d0eadd4a4b5a8fb06e0f4bf25a59ced54557388dcd91b387cb6148597edf84a22595801851ca4b9e9e096fdfc96f2444ac9f1247a5e640787fca23e3eb21ec1059c42a65803441df01279013c448dfc3eedfc3355eee1f510086a115f854c36db797a85ede19a473a33e79a80f6f7f6467e1b0d866fe0e57a8abd379934a6a6a492f5f32594d43de2ec2eea81487981bb6394bfa6df5498d74c6db2202a6348a325fbc906b8e820bb00659a2ee12740b14b2e36f4c5dab411c0cd096c5e63ba4d48aa9e92b31f44dc97c0fef661bcf4db895f174613d9d5ed9e836657745ec9deec7af273cec87ef0eaf805da1bc8401608810b8a86f952c6326d09fc8d1d7fd83b4e862e05058e877c056cc5465ec3192b03a4c33cc6b16558d2482d5f84518cbbc526aae6e8840317efb3a1982c3d1719ef15d10f8b077c5c68680be6d3d92e86aaa6eb378cf0559d493257147b55730f49a042325af066b4f9741b9fff5d47972d5acaf52b6bea4e9e354ef9448b62f6d2a1317675a922e14e31578d6cab5a09a71ab270d865151b8ab4c612b5fd5dcc97e45419a1cfb6b8b9aec60f62602098f91f07c238186657941c7a18e4d7ee220f022d5fffd291853b9c063e561b7176f7a235ce45bc86ce4718086df9536c5a5f0abf04c0a84d82bdf69552ade3135433c10a1ba69d688969e6d9dce54d3b3aae3a7f2ab904e657e3fb05241fac110aa07e62cc3991d7d0d6329b5ab9d69d7336c0d148588c9f0921325b85df5fd30db80a56a3724372153641961aa7e042bf2646ff46022c059d5794c3a4b7f90c410de71a5231dd9b83bbd0e6bdab1bf9e62f"),
			k:    mustDecodeHex(t, "b408d5d115713f0a93047dbbea832e4340787686d59a9a2d106bd662ba0aa035"),
		},
		{
			name: "count = 1",
			d:    mustDecodeHex(t, "d69cfc64f84d4f33e4c54e166b7ff9283a394986a539b23987a10f39d2d9689b"),
			z:    mustDecodeHex(t, "6de62e3465a55c9c78a07d265be8540b3e58b0801a124d07ff12b438d5202ea0"),
			ek:   mustDecodeHex(t, "3f1b8a5cf5aa0cb148cfac766a30a78209a3ce97cb427a9e813254e0b6a99ae25370b583c275357ce3b4d6c60aafda03e99734e0e98eba56aeef821e92b8c1db43942a7c37c9977d79946fe0474df27b9cf3b12ca94bb06401d09150530bf82adfc4623bd7af97425984b8c53f51969ebc02d9b41aace79536e3282af5adedb6363d4a7bdbb06a69e24c892888f6710055bb644db60ba3b884204c03b07c2a8aca0249ac29ead77d5c879a790a09b850a55ef614cc73cf7f727223ba0d6353295c008c986aa9200349a0ac500e347ee1795a1a8369ab6151c27b1341cace56852ee76c6d3ccb8331b23cde8b224af9b2dee402d9605bbfa8401976419c57ab1686bda096b28cb654cd4a5db7c32598e01491e21b8cd54497f60fe2bc31d783928e382bfbf3332b754cf969b12aa58f438b4a57064129d4456009a172a59ab3b77cc84c76944b99a53445a529ac0a62ad490174a47324a5d34b81a682a69c0a8dd75f0de93c20e430266c23b00c4869f53c6fd0854ed3caf4544952b05ed3b3b0d6ca34f0f297f2e9a7c1187804a37a121a6ad2ab50daf475aa3a25e6c9a0d6a29def62cbd298050f5b307c053a5c8838b4c3357f3376653c3366fa6fe1025d1960c75ba643265c157a84c914d559f540c67ec1587394af7bd17830d5089d505906fa9f766a9b93909f5b6627cc05a0b2192cbfc2271b0b22d77a07ce551edaa6522d402b00003723c115936c97f54c88aa513482a05554c628e69448eb6a0ef6f346341c802bdab9b03ba0af297d9e8b938b9cabefa46722421a338a872d9a88b88c9f0eec46932c367cc58b83573d26036aaf5276e515b0f23059b40c848f638ace3703ee6c27d966990c7702ed23a0cd9ba4cf6169a668a1f0bb586b076692e1c215754ff6784bd91a248cb90f008a3eca59852c057966933a1a86b6e05b2fad91b28bc61648b041a7ac046ab8112b6ac2cb900fb5c09821dc4b0716b509e122dc97c6ed7342f6f49fb65559729c384763ba2d2bb8cf56ae36f3b269970ac54841213b24b792c949f3c775e70ac8f7cc53763ff638adc5113ec60075c1a79276ca473c113832954abe207bebf0cd0426c0e29733947256c7756bf9b50d82191a07f0ba5d5a154b0866e293473b4076a1e995f9d086a472c118ac22c216a839920660a331eee198df5b1a1595239d5780cda75f73c6765a46ae4aa34001939dfad92f7e124a5f2c628b259de9560bbf470cc69cc652dc29b93ba86a4990dce0af1a4524c199a692670caf748d16612feed711f88a505d552a6440aa0422626f185f6921a82ef925086028ae8562fc7610e1b1649ef0094d96b505fbb7f112896efac0d192af45d903ac7992bbe9bf30e2577e24581cbc4f73b180d04a69f540b39e19a4ae36aec4f21ade774965391bcaebc0af869cb63631327b421bec6726651b8758bfee73c591212d4ff981f6684c58b359c2d07fa1e601d6c5cbfdc964b31909cca37fff96204fb5688d92ca5a85758cf160e9b06ed18320a4b1b0c8e8196ae76a6f621972d17a4d64a7df04c5a4c333c3bc1acaab37709149a3b8ca082a8fbca13268a1b022230e2d630272cb9ff2e6655af17327f3b9807095f582be18bd3f4e0bb723eced69b0585629986548d722b03b5bbd157ac99dee1c0a9aa1"),
			dk:   mustDecodeHex(t, "7da85623450d2b72758e9c5695ec6166e9918366163b343d9a04863af574c1e98e219a06656379b72b9d1c4ca7d2044e6f81c0e0c0098656807e3615c4530088b833953a758a3ab2f7d54a7b9b7063d373b492538a5c3ad1fc89ae618d77143fe9f818d441b69a72a1273860412614111a26e5dcc552c8810ec79ff873a5c8b253a917a2c5016fcdb37e3f76ae4e5731bd323562590f8286bb11d12a54443eaa319a3dc08fbfa2a04c3480c34928ed28b0080392e1362c2322701a89645b14083da54fbc93acab75192777c560c42e95735924a922fc61beb9253f3c9c3e2e388b08736b92c7a8279931eeeb40ffa3c0d064c015c78d6fa842906b0cce74c46e48b977d2755c221e57e3c1d24650145836823c2d27055dd5d5b821f18c17a5c41af97232602ef64218ba46c3c046ae6b127cbd031dcc79a33b7606ad281eefd8c5bb172586d426b4b1b8fc446d1fda2aabe96ea6783102663895472ef984bfdcdbcf5d0b6364b61f31c69c695151bfe8286d4ac0a08cb07f8352b6ba9319a10ae1693cc7726c954a491dc99317b1941a4107f941956e791384239c7fb96438108212eb8c6d4386670284dfa5598b4a2e2e07a443a96ca34087d97c525956544fd4c3614a7e0650677c96b52a319f2150762723bd38378799e65d5bb74504cc96a803127e9c40c65864fc736535644febda1e9fa624a7965603769291613f9ecb03de14a8ae93b502fa7515a1a68a2bab8cfb615df306e8c261a9992310970f9cda548354c312195aadc8b06be9b1260620094ba347242019ac1c8a0c22cfe06e4d6a7551a037626a5d1923877fa6ca41793cf72a1946906dddf0021bd26cdf7bca07c2a675c368e759b43d121b277b2621b1b32f236d330579a367837dd5847db64675e622bea77b067b856b49469d375a927b3a642aaaf6e2004507a90164c0efab72331b9656d6563af84bd68c7638d5c23799c3c95bb573f77e80117c01c5bb842a49eb608901cc1f04942872360783592f0d2c4ae018720ed29d452b5f42712eec98772f5b754fc1306666c59d8159f9276b562c7e76f2836ee84e3da6318b8188ca2b7d783832b257339c464b3fcc7f4764cbf09131ce6b1061a1a0bd4354fe9217549ca8efe0cd14705df274331ac73165041e7ca7bdb68ba24dd0aa6a5907231aad2cb51fd9bb8bd1691793509770a018275489f8f484e733a74a9a56d485a7a3747f5f5caa2cb38a90f04000b9c7267970a948bfd818b4a6a92e2a141075a76e699b3cb4d3a0bed4972ba2a341a6572a03bba1393647c75703621b50718d01c6bf06f6753a3aa5b4b9ba2af82ff64288a0b6c9225274caa72a7dea169aabccdb1b8969949f1a1a0840407d3d82bedcbb4fe03b9e6d718cdc35b389d32a51390dd5388797336202636481135990799b66b15cb44026f8648fda13acf2a97d3ea672a9a04246cabf186a716bf5b9c84a161818746fd83b118315d6e0ae0788cea229c297390df853c75e7b069a614ccc46c22da173ffbb851c721ae5f34b483312a8c58414170e77db53c2897f3952092d4c5a0cf18ccde1b8fad8024bfb3449a431ebcb9e2aab134b1bc24050887ae650b8aa6f41fb43bbf87767804c3f1b8a5cf5aa0cb148cfac766a30a78209a3ce97cb427a9e813254e0b6a99ae25370b583c275357ce3b4d6c60aafda03e99734e0e98eba56aeef821e92b8c1db43942a7c37c9977d79946fe0474df27b9cf3b12ca94bb06401d09150530bf82adfc4623bd7af97425984b8c53f51969ebc02d9b41aace79536e3282af5adedb6363d4a7bdbb06a69e24c892888f6710055bb644db60ba3b884204c03b07c2a8aca0249ac29ead77d5c879a790a09b850a55ef614cc73cf7f727223ba0d6353295c008c986aa9200349a0ac500e347ee1795a1a8369ab6151c27b1341cace56852ee76c6d3ccb8331b23cde8b224af9b2dee402d9605bbfa8401976419c57ab1686bda096b28cb654cd4a5db7c32598e01491e21b8cd54497f60fe2bc31d783928e382bfbf3332b754cf969b12aa58f438b4a57064129d4456009a172a59ab3b77cc84c76944b99a53445a529ac0a62ad490174a47324a5d34b81a682a69c0a8dd75f0de93c20e430266c23b00c4869f53c6fd0854ed3caf4544952b05ed3b3b0d6ca34f0f297f2e9a7c1187804a37a121a6ad2ab50daf475aa3a25e6c9a0d6a29def62cbd298050f5b307c053a5c8838b4c3357f3376653c3366fa6fe1025d1960c75ba643265c157a84c914d559f540c67ec1587394af7bd17830d5089d505906fa9f766a9b93909f5b6627cc05a0b2192cbfc2271b0b22d77a07ce551edaa6522d402b00003723c115936c97f54c88aa513482a05554c628e69448eb6a0ef6f346341c802bdab9b03ba0af297d9e8b938b9cabefa46722421a338a872d9a88b88c9f0eec46932c367cc58b83573d26036aaf5276e515b0f23059b40c848f638ace3703ee6c27d966990c7702ed23a0cd9ba4cf6169a668a1f0bb586b076692e1c215754ff6784bd91a248cb90f008a3eca59852c057966933a1a86b6e05b2fad91b28bc61648b041a7ac046ab8112b6ac2cb900fb5c09821dc4b0716b509e122dc97c6ed7342f6f49fb65559729c384763ba2d2bb8cf56ae36f3b269970ac54841213b24b792c949f3c775e70ac8f7cc53763ff638adc5113ec60075c1a79276ca473c113832954abe207bebf0cd0426c0e29733947256c7756bf9b50d82191a07f0ba5d5a154b0866e293473b4076a1e995f9d086a472c118ac22c216a839920660a331eee198df5b1a1595239d5780cda75f73c6765a46ae4aa34001939dfad92f7e124a5f2c628b259de9560bbf470cc69cc652dc29b93ba86a4990dce0af1a4524c199a692670caf748d16612feed711f88a505d552a6440aa0422626f185f6921a82ef925086028ae8562fc7610e1b1649ef0094d96b505fbb7f112896efac0d192af45d903ac7992bbe9bf30e2577e24581cbc4f73b180d04a69f540b39e19a4ae36aec4f21ade774965391bcaebc0af869cb63631327b421bec6726651b8758bfee73c591212d4ff981f6684c58b359c2d07fa1e601d6c5cbfdc964b31909cca37fff96204fb5688d92ca5a85758cf160e9b06ed18320a4b1b0c8e8196ae76a6f621972d17a4d64a7df04c5a4c333c3bc1acaab37709149a3b8ca082a8fbca13268a1b022230e2d630272cb9ff2e6655af17327f3b9807095f582be18bd3f4e0bb723eced69b0585629986548d722b03b5bbd157ac99dee1c0a9aa180bdc36919442424bc921c96811a00347c0448ba09637e187b212b77e7e976b66de62e3465a55c9c78a07d265be8540b3e58b0801a124d07ff12b438d5202ea0"),
			m:    mustDecodeHex(t, "0121cb32acd1871135cb34e29c1a0e26ccc001b939eafaacc28f13f1938dbf91"),
			ct:   mustDecodeHex(t, "4cfd0f0be15ddb620586446e4351182f64aaac3affa13b24652b87d6ed91f60cd3d317912c1984cb98d5a393b0b575f20a5afebc58db8aa8c79476187f8fea072fffd26f12006159518661daa4654f60e38a5eec796383df0457828aa32973187c19a64792858ade46c77a53d1b6a9aee2c4db237be35234e180bf0106804c08a3d9617887828696ea6136594031d1b68ef5745e618a9c3b07d0fb00f481c47d12154c579d002ff69b8f5b3208b62bec8b5d46fc94b12a3111555dcdacbe2548d33bf24ab237ab066543e2ad47ba165853acd707fc5a1955d4ad83384dd936af95eb007a8423aa35362fd73501d68909cf8d377a4b8b021551276547bad26bda1f735135a6662c6ce047bf3e146fca5af3ffd7b75c8645d8525d4a22b05061797868adb514c5f9e8fae5fc27380c7ef02e671941fbeff63b3e7eb55bb5e00ea3f34d6badfa24bcc2bf803e4434dcde2712c951ec83a64454d5565ad1488b1a78051b9f72b68d5581af2949d1630098f48b4fa7e595223ce7309d7f79d250dc2a91bac5138714973e93f67044a73c86ea3a29ad5632277b6596509d644e1dcb55d3a8fd1d91996f2d9ff471b4f1e31a759af4875148b4d4f1f8dc6c792cc8ed9a29935bd04f3ac12801574ec29f3b601a8d75d3f44d55e8a14c5b63b1ef7fbacdaa80fd7370b8dc7a1618581bfb8327f262a3037015aec3486a8b3ae11504520ddd509b986fa22035cbb2fd242acbca7aaea5f898e6101337b50ec7cfece1c2f2dccdd464e57606e44877f96c27206523837b4dca5a2f65ffb3971669ca9d983bad154d1b11f86a3a376e6981e3ec2ee420864381035678ad18c13c382587b2ffb67b3c56068a3d539077941a6876745d5a1cb25f1e897a59467efcf886ef1d7122874e54b24ed5249468723ddc54198880e9405f0f0b94e6dd95026046a60db1cf3a1d92083fb8104aea7470157857085925968d78ca35258b8e7a2bc4d3e14f404a2d5eddfefbaab1836a25a6444c31842e8f56395b335da8830c91a8106a5313c80020915ce0c79c303266933d876e854096cf6bac835181a38795711cfc1e973dc7c412ce5037604991902f3f81ac36360b37187106daa044af03de0a454b7b3f3996f3e4858e20f87fd98ca663ce21a9b5309b27737b9df732532b0fc9b2a2de6cde4e0597dbd6ab9cccced9f7ce2c4c727c9aa4358e4f5da251138f104f66891fcc671c64e5500ce3d3ad27a6272eed5bfd4491eae6dc1de6e7696f380d89aaa653571aa3132ca54806f9308c414bdb2897cbb6b844e8e04fd94732fa9c3de0f6472cbd0fd74f98d49b0d5fc5772d213ee8bbec2e8593024d03576e851696635822b980b1345d5df9b9386e939a2f8e324fba84c12f8de6e27fb0709d577ae6ee48aa3f2e7a709486bdf68cba1284cde4b3e3a47b510fa6a6accaa0609e822c0ccc9fd51000cdd57830b37590ac9b3b29d3be01400d6e7bdb640d1e221c26ff7b24fd67a6ee0a5652ad5d50d4ea408b1e10c974e86094e5b40e08b66e7c"),
			k:    mustDecodeHex(t, "8c970242406111e26368ad8760c4d02a8b28d17d138210adc127197b50968140"),
		},
		{
			name: "count = 2",
			d:    mustDecodeHex(t, "63470357110828f25b23edc80ed280ecd398a9f53251c3332754de2af0b15e90"),
			z:    mustDecodeHex(t, "1eaae6bb91b27cd748c402c4111140d5a942cf3c95ff7977f88d2ef515bb26d0"),
			ek:   mustDecodeHex(t, "d0060a40910a30ba326e784ad37476107bc94df36ad4d86027981a834c6beb4225e62949dbe92970cb82e14072e54a6ebb462f20e3281db1b92644a021cb48895c665b445571a76aad1330adf7ce7a012da8d4c8cf665d1ba1bbf512687eaca39b62c44bb78b42018c16989c4e538338e983b31163646ba1086329e19a6485734fafd5376a07696575792403975b548920a50dd32357cd60ca691a16195aa06eb409b50154f59c4346f71ac6ea9be54b0798390d7930a23e0b066af5c5677708f6e8c92db2af44d70c6403c4af9c5305bb89b3ac7f695b26ecdbb757796c3fc96d97577bc5667d7506a74695076f1a97e0e253bfaa9a12d011414c1f05bc372e54804bd73e3ddc523c11594bf5642b9843b1cc16ce13937d66cd6f40080710ba9e747acb0a6696b93ec66aa47d727724b1cee2976619082841a3a29b8590c9219676cc75366342838a9edf573b57e4bf23542d6a2107e6562d16f030e2c19afa0870ed124614a285b82b40b84a131cbb100ca62d1b623a07f0575c7862bccc9e6ff402fbc89fd2c1ca62068e0ae88fcea6cd8fa2abcde18f4b3887d98232addc3a4f2413c374431023c16ef65b8ec3c885a0990d6189b4cc1a145ac3d8932a2d7857836a6546bc58a7cb3745c1a8fc41ba3a2c3be5725f5b9248610ccf5df4454178a8485681d5bbc484db487997cc49975e7c923f7654457530b2e8796ae15cc6dbf6967a0496ec16ce292c9b1b6c8f354b27b9b5311db71af370c13f510e55ba5a49690c8e76c0925c5f43b7679be2bc9afac67ba8a258acc8d2284f490779d0e634eef4762dd79da8c19080e6b05a5c0226910372671429ab0cc8888a6e7b9969727f495cafd82acc92a8361e234b11600cd7c9275f1482b4018e7b44031c305774952a26634876c578bf7a24d1649805fabf2c7ccdaf576619db784799bdf09220d5c3729ed0cafc863993c290b550c17eac6def28a02af431e515a2cc8c594bb4ce726bc964f4c07c051531f617db1bb0970a0d5c1a7c3312681f71910940b758132409087de3ecb7cec6921da70f46f57fdb34a90ac11b7e717b4416a75a703ce0306112cb34030500a6651513b776b32529638cc59f7929ef172c72a740e5c7338abaca58f089dc8aaedd2654681b4ea1fb42bac7a1c17917bda9a01081b18e0545860a1a76084408165e63606c99658e2df241ddd83997794e407929b75bac2f177633e279fd2817ec2b7fa239a613a0a496c19f01fa5a96a86c66ec3458f086b01b2e60f396d75624988584c2755c0a130508c982a69332ebf8ca92a9230dc95f5d96646ac246d27035d00b9dba456a621572e34c6af36b14c0100002a892b520b5586529a076025a332e01d802cc10810fc79aeb137db61b88b3e67148e84736436ac69a5cf6502ce7f84a09c7a6dd1797c13100a0657461105c197c92b6d47ebf6724e84b00a1d2a55974ac18f59f1eb2719ed49d464a4f41823f169492d594100a4a8b8ad71995f730a934c5e8e9ccb80c54b453c03cf37b8cc98935c24f35d41bd0090fc29c04dcb8c06c6c08cf299c084a7132b38ff8c82740f066beb6c5b94ab36bd68a0490a457cba78bd5905e5ba18a8a496ae526558aa74367db2cccac958f8410f88320a5a73e820e5d8178ad728ba7ff67cac50775c3"),
			dk:   mustDecodeHex(t, "76fa8d080a3a20eb8b40361f774cb4de7383dd88958372396eb74ee3bbc7b40c982f4331dca727d374c2a459ac4cdb1bc9a89ecd8c378fe8a6541692bda26ebec73c3de8c2c2aa39c3d61c85bb288ebb8a38c7938af27a2bbb23906654c1a966180261488b0139e6a7aadb2c61d9bad552245c0a3678c16580e0b163f6ae7df2b0126b107ddc7a9f0558e9a12d44587b6146aa892518a76115c49aa663c1a58ae700b9e608cbc45f5f7ba99832ce726a6b515b5faf24030574af6d090f8fbaa4a4f96fb8d815d477a9a43ab74e369582f3872578618ec615269349c8eb9362f862ff52af8fa29228a0cbdb381f92b08506c3a66fe04d914599da32ada67799212231df226a24a9384bec816362095381029a9b2a8fbbcf06356af2b9bfd1613b2dc462f7cc1d1dc07278376967598ff7228b480864e8f59f9eeb3e22f6a1a4936f37cc568d295d3fc61679c6bc8ecb1887b35a093c2b432b467e281855744e0a62a84d7787476ba009a20133644999f6951f32b51cb8762fd708163b89eb15c680800377e11ffc7cb3fd04559c92a50e1501f8f4840cea43c8c7c715979a04c5b703c68784f92d0a0866ef1992127126e0f02b53f8b9fa289509398b4a9aa9b0c64ad8661d93f143546451580812ae433a3210b49f74894dcb5feab650cf251330892d7366071b44cc032c7d1c937b51a667b0cc2752624c1380a5c365910c970cef238bddd79823452b7a240ee6b29def969188b97987b218471097a0f6bb1dcabe933ab24e015335a664d1a42375d231377627ffca161d292d807409af4936af255f40f95dd460058c12a43eb027365b032cc1786afa4f1aabb0f87b3db1a9878082012a9c79f55165aba764da9b2e4305c43b122488d9b340ba4811429fcb6105c937388373375d22537b1512b2cc250fa64f43b6be72e5c849a61464d36272f6c6847a41365167a42343012227bf8c76fb629493265ffc4899d58c6927094a46505db949cec8030d1b19cf4f9c5fb1582f6e1477287b00ce86b76abb69ec11bf5ba134fb7b40a79ac284e2c3e5018bf553a4b30877dd54c591d9be49438100b08ea8c902013b9b6a11b6d06a4834b3225ec7a3a5c59176a2240a944f4cf95be0b27148a3a3fc51a4d7253c0862a0008784f541b9bfb77fc4fb8a6e6b428dbc8c51a6a8a1819fbef4ce11c5151199236c4c82a1f027fa409283c4798e754585fca3e8004c3d29177b1c7506c70591fc278ba4ae69dba78e6caf43a617bcc465240c71df369a1ef6c6d12baa95158a5c168f293aabb6d65cb1c301ce471a7783b91aa18d97281b2e7b64f9e64c4ceb0ab118bce2e56c43a04388f12f05cb11c6aac8a64bc63b56bfee9322c4e7aa599a9e2240ab80f26e89b5a0cd3c57879c89f41c9b8718c76b95c4a79b1bf7410176c955ca40bc1d07a5312c0271f73a33bb81f05c79812b5c65373ba0b9a033d56efe1b7855e26ea940b534e81043976b7106320e3464a99935498b2045fb15b32aa762f7c66b1a3319e8570956a0550ab81720a83abb25df5021ca2c44f5a67ed8eb5dfad134201b39ef7979499c8797602914373f8e053bc276a860106f4c5212f8e13a8d829ee9d8a926f2baffc746d0060a40910a30ba326e784ad37476107bc94df36ad4d86027981a834c6beb4225e62949dbe92970cb82e14072e54a6ebb462f20e3281db1b92644a021cb48895c665b445571a76aad1330adf7ce7a012da8d4c8cf665d1ba1bbf512687eaca39b62c44bb78b42018c16989c4e538338e983b31163646ba1086329e19a6485734fafd5376a07696575792403975b548920a50dd32357cd60ca691a16195aa06eb409b50154f59c4346f71ac6ea9be54b0798390d7930a23e0b066af5c5677708f6e8c92db2af44d70c6403c4af9c5305bb89b3ac7f695b26ecdbb757796c3fc96d97577bc5667d7506a74695076f1a97e0e253bfaa9a12d011414c1f05bc372e54804bd73e3ddc523c11594bf5642b9843b1cc16ce13937d66cd6f40080710ba9e747acb0a6696b93ec66aa47d727724b1cee2976619082841a3a29b8590c9219676cc75366342838a9edf573b57e4bf23542d6a2107e6562d16f030e2c19afa0870ed124614a285b82b40b84a131cbb100ca62d1b623a07f0575c7862bccc9e6ff402fbc89fd2c1ca62068e0ae88fcea6cd8fa2abcde18f4b3887d98232addc3a4f2413c374431023c16ef65b8ec3c885a0990d6189b4cc1a145ac3d8932a2d7857836a6546bc58a7cb3745c1a8fc41ba3a2c3be5725f5b9248610ccf5df4454178a8485681d5bbc484db487997cc49975e7c923f7654457530b2e8796ae15cc6dbf6967a0496ec16ce292c9b1b6c8f354b27b9b5311db71af370c13f510e55ba5a49690c8e76c0925c5f43b7679be2bc9afac67ba8a258acc8d2284f490779d0e634eef4762dd79da8c19080e6b05a5c0226910372671429ab0cc8888a6e7b9969727f495cafd82acc92a8361e234b11600cd7c9275f1482b4018e7b44031c305774952a26634876c578bf7a24d1649805fabf2c7ccdaf576619db784799bdf09220d5c3729ed0cafc863993c290b550c17eac6def28a02af431e515a2cc8c594bb4ce726bc964f4c07c051531f617db1bb0970a0d5c1a7c3312681f71910940b758132409087de3ecb7cec6921da70f46f57fdb34a90ac11b7e717b4416a75a703ce0306112cb34030500a6651513b776b32529638cc59f7929ef172c72a740e5c7338abaca58f089dc8aaedd2654681b4ea1fb42bac7a1c17917bda9a01081b18e0545860a1a76084408165e63606c99658e2df241ddd83997794e407929b75bac2f177633e279fd2817ec2b7fa239a613a0a496c19f01fa5a96a86c66ec3458f086b01b2e60f396d75624988584c2755c0a130508c982a69332ebf8ca92a9230dc95f5d96646ac246d27035d00b9dba456a621572e34c6af36b14c0100002a892b520b5586529a076025a332e01d802cc10810fc79aeb137db61b88b3e67148e84736436ac69a5cf6502ce7f84a09c7a6dd1797c13100a0657461105c197c92b6d47ebf6724e84b00a1d2a55974ac18f59f1eb2719ed49d464a4f41823f169492d594100a4a8b8ad71995f730a934c5e8e9ccb80c54b453c03cf37b8cc98935c24f35d41bd0090fc29c04dcb8c06c6c08cf299c084a7132b38ff8c82740f066beb6c5b94ab36bd68a0490a457cba78bd5905e5ba18a8a496ae526558aa74367db2cccac958f8410f88320a5a73e820e5d8178ad728ba7ff67cac50775c344bbb60ce3a7611dfc6a14b2d4f91a50993fba4ad785d8f05cb8a23ed8f9e89a1eaae6bb91b27cd748c402c4111140d5a942cf3c95ff7977f88d2ef515bb26d0"),
			m:    mustDecodeHex(t, "34b961af5d6254af72c0d50e70dd9b4991150ccc09192aa46f1953d5c29a33ec"),
			ct:   mustDecodeHex(t, "0dad9235274660119510231d6282e3d862ceea5365b9c7f783078891f3358568ffb10086d0685aac868c39235ae909ab7f4c65dfe149b5f69eb0c94080947958d71db262b5fdc05a1ad881131ecfc1c78986187f394140d392359a6456fcea0ee1ce0893985b7b614c46f0445d123e5876246331ad742345c2f74e1da09235a101122fb78b73e8f1b52cd8191d6fa780e55b89257cfb581443e5aca52149c423d7658c6aac7743d5c3188e61397a7408f9c52a8cc8e8ef18370674c5cfc0f03c51c589e79e2f2631ff81bc851eeb5789247ad3a0f956d2a74c17f935ae7dc9a463f3ee150c8f3485523899182b84011da1fd4058a66be3102a0818246d93e987d27e279801377d317bed6ef9cecb745c96d348501be3e4d5364f27ad7374132c58e3dbe65b1801482a89432fd4fcda0850eab1c75b035b4b8f0eccd0f56161e61e0b5a1e43b995f8ebdc0a92ff299719b6ab223e84f1bd816cdec05e35126441e4c3f097d8c6a98f49c137b37fce1d24587f810d500cbdec5a187d36967c5f2202b4b7ffb4a21a8751890ecf4c722ff46b113cd78932de35a7aa614bdcdf276be1f03674834e7dc75439ea8aaf1c88173bc7ffb8527dd85fa44c1c8c4a50b246cde630169245a87e68b0dae6925405cdfc4e0956d53ea7ecf767dc5dada24fd99f6e89a8472bfe9d25ce8807bd93da5b1f2268368847d77657ac6cbaec6de7d487b2c7adc1f866d769feed319f4a71f5564ff9b462dbd731eb81b603f051147425d4a91c081f349706cb76d8c702ab902f29f337b3b64b063881f58fd89410596880ea32b2c46fce458e224034230745c5e8933caa77b8d4f0970a582ecfc3dbd74178bed3f7f47a41f8e5a43e74e69f01471b8caf7c49ef75dfef9bb2c80206f1ad2547640b6b3b335e06f252f08a7aef02202b6a43604eb3517a0426ab50e5efeed9479f62f0b3a603081979a0e830cf08be3340cc452700cadccae3cbb23163728567b1ce2f340a1df94384366a061c1373ceabaaf8988e10fd2049333473277c87185a6a1ad07499f8ceb29d11d504bee7fb0d6e585fb812bcb6aa91e0cc18caad071b8b3d1f307fe872b13107c8f24cf94731000a1ba1923f32021f127900f8f7238fa95988299879a45d560a329479a468c0101b34991cf600c5043ed8b3ed2250615ca3fd5018f704603cf6dc53f25e2e84ec64f5e42cd8b9aedb8011d3a0210b20d97b68e8848450dacf44916a9cb785d804c444e9e7d307d75870c22583ba395679f1927236c570f40db0dc2a90c162b4fc66cf31556d6cd0a02c80c6d422b7545c686ca5023771d9b0749c6d1dc1e93ea0aa991b1a05e726782623a52f10fe4dd53458be8a2d660b95ddbd930d67ff5b8eabd961e68a2bd51bee935ca8bcc79db1fdba2c7884ddee00615da89c07f895c4185993c67d43268490e778baba6e3e9b02b6e68e9119788497f949de3e376960c220354784929cc2797d841ab279ee3932b8470bd28574363d1bad87f72b6948853e919658db447c0808"),
			k:    mustDecodeHex(t, "c0d45764e3dbf0948b914d6f65c92bd0ebd21556e5076753af48df8fffd6badc"),
		},
	} {
		t.Run(tc.name, func(t *testing.T) {
			var dz []byte
			dz = append(dz, tc.d...)
			dz = append(dz, tc.z...)
			pub, priv, err := MLKEM768.DeriveKeyPair(dz)
			if err != nil {
				t.Fatalf("DeriveKeyPair = %v", err)
			}
			pubBytes := []byte(*pub)
			if !bytes.Equal(pubBytes, tc.ek) {
				t.Errorf("ek =\n%x\nwant\n%x", pubBytes, tc.ek)
			}

			key, ciphertext, err := MLKEM768.EncapDerand(*pub, tc.m)
			if err != nil {
				t.Fatalf("EncapDerand = %v", err)
			}
			if !bytes.Equal(*ciphertext, tc.ct) {
				t.Errorf("ct =\n%x\nwant\n%x", *ciphertext, tc.ct)
			}
			if !bytes.Equal(key, tc.k) {
				t.Errorf("k =\n%x\nwant\n%x", key, tc.k)
			}

			decapsed, err := MLKEM768.Decap(*priv, *ciphertext)
			if err != nil {
				t.Fatalf("Decap = %v", err)
			}
			if !bytes.Equal(decapsed, tc.k) {
				t.Errorf("k =\n%x\nwant\n%x", decapsed, tc.k)
			}
		})
	}
}
